<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字化验车清单工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Excel 处理核心库 -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .card { border: 1px solid #e5e7eb !important; box-shadow: none !important; break-inside: avoid; margin-bottom: 1.5rem; }
            textarea { border: 1px solid #f3f4f6 !important; background: transparent !important; resize: none !important; }
            .group-header { background-color: #f9fafb !important; -webkit-print-color-adjust: exact; }
        }

        .custom-checkbox:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .drop-zone {
            border: 2px dashed #e2e8f0;
            transition: all 0.2s ease;
        }

        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.01);
        }

        /* 消息提示框样式 */
        #notification {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(100px);
            opacity: 0;
        }
        #notification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- 顶部导航栏 -->
    <nav class="bg-white border-b sticky top-0 z-30 no-print">
        <div class="max-w-4xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </div>
                <span class="font-bold text-lg tracking-tight">验车助手 <span class="text-blue-500 font-medium text-sm ml-1">v2.1</span></span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-full text-sm font-semibold shadow-md transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"></path><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    导出报告
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8">
        
        <!-- 文件上传区域 -->
        <section class="no-print mb-10">
            <div id="dropZone" class="drop-zone bg-white rounded-2xl p-10 text-center cursor-pointer shadow-sm relative overflow-hidden">
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv">
                
                <div id="uploadUI">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </div>
                        <div>
                            <p class="text-xl font-bold text-slate-700">导入您的验车清单表格</p>
                            <p class="text-slate-400 mt-1">支持 Excel 或 CSV 文件，系统将智能识别内容</p>
                        </div>
                        <div class="flex gap-4 mt-2">
                            <button onclick="document.getElementById('fileInput').click()" class="text-blue-600 font-semibold text-sm hover:text-blue-700 underline decoration-2 underline-offset-4">浏览文件</button>
                            <span class="text-slate-300">|</span>
                            <button onclick="loadDemoData()" class="text-slate-500 font-semibold text-sm hover:text-slate-700 underline decoration-2 underline-offset-4">加载演示数据</button>
                        </div>
                    </div>
                </div>

                <!-- 加载中状态 -->
                <div id="loadingUI" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center">
                    <div class="flex flex-col items-center gap-2">
                        <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p class="text-sm font-bold text-blue-600">正在解析文件...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 动态清单内容渲染区 -->
        <div id="checklistContent" class="space-y-8">
            <!-- 默认缺省页 -->
            <div id="emptyState" class="flex flex-col items-center justify-center py-24 text-slate-300">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mb-4"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="13" x2="15" y2="13"></line><line x1="9" y1="17" x2="15" y2="17"></line></svg>
                <p class="text-lg font-medium">尚未加载清单内容</p>
                <p class="text-sm mt-1">上传 Excel 或点击“加载演示数据”开始</p>
            </div>
        </div>

        <footer class="mt-20 border-t pt-8 pb-12 text-center">
            <p class="text-slate-400 text-sm">© 2026 提车数字化助手 · 专业验车凭证生成工具</p>
        </footer>
    </main>

    <!-- 消息提示 -->
    <div id="notification" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-50 px-6 py-3 bg-slate-800 text-white rounded-full shadow-2xl flex items-center gap-3 no-print">
        <span id="notifyIcon"></span>
        <span id="notifyText" class="text-sm font-medium"></span>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const contentArea = document.getElementById('checklistContent');
        const loadingUI = document.getElementById('loadingUI');
        const notification = document.getElementById('notification');
        const notifyText = document.getElementById('notifyText');

        function showNotify(text, type = 'info') {
            notifyText.innerText = text;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // 拖拽手势
        ['dragenter', 'dragover'].forEach(eName => {
            dropZone.addEventListener(eName, (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eName => {
            dropZone.addEventListener(eName, (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
        });

        dropZone.addEventListener('drop', (e) => {
            const file = e.dataTransfer.files[0];
            if (file) processExcel(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processExcel(file);
        });

        function processExcel(file) {
            loadingUI.classList.remove('hidden');
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length > 0) {
                        renderUI(jsonData);
                        showNotify('清单同步成功！', 'success');
                    } else {
                        showNotify('表格似乎是空的。', 'error');
                    }
                } catch (err) {
                    console.error(err);
                    showNotify('解析失败，请确保文件格式正确。', 'error');
                } finally {
                    loadingUI.classList.add('hidden');
                }
            };

            reader.onerror = () => {
                showNotify('文件读取出错。', 'error');
                loadingUI.classList.add('hidden');
            };

            reader.readAsArrayBuffer(file);
        }

        function loadDemoData() {
            const demo = [
                { "类别": "重中之重", "检查项目": "表显里程", "注意事项": "核对里程不超过20km，超过50km建议拒收。" },
                { "类别": "重中之重", "检查项目": "VIN码核对", "注意事项": "核对铭牌、玻璃、合格证三码合一，检查第10位年份（P=23年, R=24年）。" },
                { "类别": "外部检查", "检查项目": "漆面观察", "注意事项": "室外光线下观察是否有色差、划痕或补漆痕迹。" },
                { "类别": "外部检查", "检查项目": "玻璃生产日期", "注意事项": "检查全车玻璃，日期必须早于整车出厂日期。" },
                { "类别": "随车物品", "检查项目": "钥匙数量", "注意事项": "确认有两把原厂智能钥匙。" }
            ];
            renderUI(demo);
            showNotify('演示数据已加载。');
        }

        function renderUI(data) {
            contentArea.innerHTML = ''; // 清空内容

            // 智能识别表头
            const getVal = (row, keys) => {
                for(let k of keys) {
                    if(row[k] !== undefined) return row[k];
                }
                return null;
            };

            const catKeys = ['类别', 'Category', '分组', 'Group'];
            const titleKeys = ['检查项目', '项目', 'Item', '任务', 'Title'];
            const descKeys = ['注意事项', '备注', '详情', '描述', 'Details', 'Note'];

            // 数据分组逻辑
            const grouped = data.reduce((acc, row) => {
                const cat = getVal(row, catKeys) || '其他项目';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(row);
                return acc;
            }, {});

            Object.keys(grouped).forEach((cat, gIndex) => {
                const section = document.createElement('div');
                section.className = 'bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden card';
                
                let rowsHtml = grouped[cat].map((item, iIndex) => {
                    const title = getVal(item, titleKeys) || '未命名任务';
                    const desc = getVal(item, descKeys) || '';
                    const id = `check-${gIndex}-${iIndex}`;
                    
                    return `
                        <div class="group p-5 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors">
                            <div class="flex items-start gap-4">
                                <div class="relative flex items-center h-6 mt-1">
                                    <input type="checkbox" id="${id}" class="custom-checkbox w-6 h-6 rounded-md border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer transition">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <label for="${id}" class="block font-bold text-slate-800 text-base cursor-pointer group-hover:text-blue-700 transition-colors">${title}</label>
                                    ${desc ? `<p class="text-sm text-slate-500 mt-1 leading-relaxed">${desc}</p>` : ''}
                                    <textarea placeholder="输入现场记录..." 
                                              class="mt-4 w-full p-3 bg-slate-50 border border-slate-100 rounded-xl text-sm text-slate-600 focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition-all placeholder:text-slate-300"></textarea>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                section.innerHTML = `
                    <div class="group-header bg-slate-50/80 px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="font-bold text-slate-600 flex items-center gap-2">
                            <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                            ${cat}
                        </h2>
                        <span class="text-xs font-semibold text-slate-400 bg-white border px-2.5 py-1 rounded-full shadow-sm">${grouped[cat].length} 项任务</span>
                    </div>
                    <div class="divide-y divide-slate-50">${rowsHtml}</div>
                `;
                contentArea.appendChild(section);
            });
        }
    </script>
</body>
</html>
